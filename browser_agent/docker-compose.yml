services:

  playwright-mcp:
    image: mcr.microsoft.com/playwright/mcp
    expose: ["8931"]
    init: true
    # This image is normally intended to be launched and controlled by a client via stdio,
    # where the MCP server runs as a subprocess.
    # Here we override the entrypoint to run it as a standalone MCP server, with Streamable HTTP transport.
    entrypoint: ["npx", "@playwright/mcp@latest", "--headless", "--browser", "chromium", "--port", "8931"]
    # Check if the MCP server is listening on port 8931 using a simple TCP connection.
    # Exits 0 if the port is open (healthy), or 1 if the connection fails (unhealthy).
    # We use Node because other commonly used commands are not available in this image.
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('net').connect({host:'localhost',port:8931},()=>process.exit(0)).on('error',()=>process.exit(1))\""]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s


  hayhooks:
    build: .
    expose: ["1416"]
    volumes:
      - ./pipelines:/pipelines
    environment:
      - HAYHOOKS_PIPELINES_DIR=/pipelines
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}      
    depends_on:
      playwright-mcp:
        condition: service_healthy

  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.6.24
    container_name: open-webui
    # volumes:
    #   - open-webui:/app/backend/data
    ports:
      - 3000:8080
    environment:
      GLOBAL_LOG_LEVEL: "DEBUG"
      # Here we make the default OPENAI_API_BASE_URL point to hayhooks...
      OPENAI_API_BASE_URL: http://hayhooks:1416
      # ...and we use a dummy key for the OpenAI API key (not needed)
      OPENAI_API_KEY: "dummy"
      # Other settings
      ENABLE_TAGS_GENERATION: "True"
      ENABLE_TITLE_GENERATION: "True"
      ENABLE_FOLLOW_UP_GENERATION: "False"
      ENABLE_EVALUATION_ARENA_MODELS: "False"
      ENABLE_AUTOCOMPLETE_GENERATION: "False"
      ENABLE_CODE_EXECUTION: "False"
      ENABLE_OLLAMA_API: "False"
      ENABLE_DIRECT_CONNECTIONS: "False"
      # Auth
      WEBUI_AUTH: "False"
      DEFAULT_USER_ROLE: user
      # Disables Open WebUI's network connections for update checks and automatic model downloads.
      OFFLINE_MODE: "True"
      DEFAULT_PROMPT_SUGGESTIONS: |-
        [
          {
            "title": ["3-day in Japan", "Street Food + Culture"],
            "content": "Plan a 3-day trip to Japan focusing on street food and culture. I prefer boutique hotels, have a moderate budget, and will be traveling by train. I want to visit Tokyo, Kyoto, and Osaka."
          },
          {
            "title": ["4-day in California", "National Parks + Coast"],
            "content": "Plan a 4-day California road trip focusing on national parks and coastal drives. I prefer cozy motels and cabins, have a moderate budget, and will be traveling by rental car. I want to visit San Francisco, Big Sur, Santa Barbara, Joshua Tree, and Yosemite."
          },
          {
            "title": ["Weekend in Barcelona", "Architecture + Tapas"],
            "content": "Plan a 2-day weekend trip to Barcelona focusing on architecture and tapas. I prefer central 4-star hotels, have a moderate budget, and will be traveling by public transport. I want to visit Sagrada Familia, Park Guell, the Gothic Quarter, and Barceloneta beach."
          }
        ]
    depends_on:
      - hayhooks
    restart: unless-stopped   


  
